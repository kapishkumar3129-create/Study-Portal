<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Minhas Notas</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        #editor-container { height: 60vh; background: #1e1e1e; color: #e0e0e0; border: 1px solid #444; }
        .ql-toolbar { background: #2d2d2d; border-color: #444 !important; }
        .ql-stroke { stroke: #e0e0e0 !important; }
        .ql-fill { fill: #e0e0e0 !important; }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="index.html" style="color: var(--text-color); text-decoration: none; display: flex; align-items: center; gap: 5px;">
            <span class="material-icons">arrow_back</span> Voltar
        </a>
        <h3 style="margin:0;">Caderno Digital (Cloud)</h3>
        <button id="theme-toggle" class="theme-btn" onclick="toggleTheme()">ðŸŒ™</button>
    </div>

    <div class="notes-container">
        <div id="editor-container"></div>
        <div class="export-group">
            <span id="save-status" style="color: #888; display: flex; align-items: center; gap: 5px;">
                <span class="material-icons" style="font-size:16px;">cloud_queue</span> Sincronizado
            </span>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script type="module">
        import { auth, db } from './firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }]] }
        });

        let uid = null;
        let timer;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                uid = user.uid;
                const snap = await getDoc(doc(db, "notes", uid));
                if (snap.exists()) quill.root.innerHTML = snap.data().content;
            } else {
                window.location.href = "login.html";
            }
        });

        quill.on('text-change', () => {
            if(!uid) return;
            document.getElementById("save-status").innerText = "A guardar...";
            clearTimeout(timer);
            timer = setTimeout(async () => {
                await setDoc(doc(db, "notes", uid), { content: quill.root.innerHTML });
                document.getElementById("save-status").innerText = "Guardado âœ…";
            }, 1000);
        });

        window.toggleTheme = () => document.body.classList.toggle("dark-theme");
        if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark-theme");
    </script>
</body>
</html>